{{/* 
   partials/lastfm-recent-track.html 
   This Hugo partial fetches and displays your recent track from Last.fm
*/}}

{{ $lastfmapiKey := getenv "LASTFM_API_KEY" }}
{{ $lastfmusername := getenv "LASTFM_USERNAME" }}

<head>
  <style>
    /* Target all <a> tags within .track-info on the index page */
    body.home #lastfm-recent-track .track-info a {
      text-decoration: none; /* Remove underline */
    }

    /* Or, if you want to target the .track-info class itself */
    body.home #lastfm-recent-track .track-info {
      text-decoration: none; /* Remove underline from all links within .track-info */
    }
  </style>
</head>

<div id="lastfm-recent-track">
    <p>Pulling Last.fm API ...</p>
</div>

<style>
#lastfm-recent-track {
   background-color: #f0f0f0; /* Light background */
   border: 1px solid #ddd; /* Subtle border */
   padding: 20px;
   border-radius: 5px; /* Rounded corners */
   text-align: center; /* Center content */
}

#lastfm-recent-track p {
   margin-bottom: 10px;
}

#lastfm-recent-track img {
   max-width: 100%;
   height: auto;
   border-radius: 3px; /* Slightly rounded image corners */
   box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow */
}

#lastfm-recent-track {
    display: flex; 
    align-items: center;
    background-color: #e0f2f1; /* Match the image background */
    border: none; /* Remove border */
    padding: 15px; 
    border-radius: 8px; /* Slightly more rounded corners */
}

#lastfm-recent-track img {
    width: 80px; 
    height: 80px; 
    margin-right: 15px;
    border-radius: 5px; /* More rounded corners for the image */
}

#lastfm-recent-track .track-info {
    text-align: left; 
}

#lastfm-recent-track .track-info .track-title span {
    text-decoration: none;
	margin: 0 0 5px; /* Add bottom margin */
    font-size: 1.1em; 
    font-weight: bold; /* Slightly less bold */
	color: #4c4f69;
	--a: -45deg;
    --t: .23em;
	--_s: calc(var(--t)*cos(var(--a)));
	background:
		linear-gradient(var(--a),#0000 var(--_s),currentColor 0 calc(100% - var(--_s)),#0000 0) 
		bottom/var(--i,90%) var(--t) no-repeat;
	padding: 0 .25em calc(var(--t) + .1em);
	-webkit-box-decoration-break: clone;
    box-decoration-break: clone;
	transition: .3s;
	cursor: pointer;
}

#lastfm-recent-track .track-info .track-title:hover span {
	--i: 100%;
}

#lastfm-recent-track .track-info p {
    margin: 0;
    font-size: 0.9em;
    color: #5c5f77;
}

#lastfm-recent-track .now-playing {
    margin-top: 5px;
    font-size: 0.8em;
    color: #6c6f85;
}
</style>

<script>
    // Replace with your actual Last.fm API key and username
	const apiKey = "{{ $lastfmapiKey }}"; 
	const username = "{{ $lastfmusername }}";

    // Construct the Last.fm API URL
    const apiUrl = `https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${username}&api_key=${apiKey}&format=json&limit=1`;  


    // Fetch recent tracks from Last.fm API
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            // Extract the latest track information
            const track = data.recenttracks.track[0];
            const artist = track.artist['#text'];
            const songName = track.name;
            const albumName = track.album['#text'];
            const artworkUrl = track.image[3]['#text'];
			const nowPlaying = track['@attr'] && track['@attr']['nowplaying'];
			const songUrl = track.url

            const albumElement = document.createElement('p');
            albumElement.textContent = albumName;

            const artworkElement = document.createElement('img');
            artworkElement.src = artworkUrl;
            artworkElement.alt = `Album artwork for ${albumName}`;
			
			const nowPlayingElement = document.createElement('p');
			nowPlayingElement.classList.add('now-playing');
			nowPlayingElement.textContent = nowPlaying ? "Now playing" : "Most recent track";

            const trackContainer = document.getElementById('lastfm-recent-track');
            trackContainer.innerHTML = `
                <img src="${artworkUrl}" alt="Album artwork for ${albumName}" onerror="this.src='path/to/default-image.jpg';"> 
                <div class="track-info">
                    <h3 class="track-title"><span><a href="${songUrl}" target="_blank">${songName}</a></span></h3>
                    <p>${artist}</p>
                    <p>${albumName}</p>
                    ${nowPlayingElement.outerHTML} 
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching recent tracks:', error);
            document.getElementById('lastfm-recent-track').innerHTML = '<p>Unable to load your recent track. Please try again later.</p>';
        });
</script>